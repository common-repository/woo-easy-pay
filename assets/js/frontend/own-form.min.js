jQuery(function(a){if("undefined"!=typeof worldpay_own_form_params){var c={vars:worldpay_own_form_params,cvc_selector:"#worldpay_cvc",payment_method_received:!1,cvc_received:!1,init:function(){if(this.gateway=this.vars.gateway,this.payment_type_selector='[name="'+this.gateway+'_payment_type_key"]',this.container="li.payment_method_"+this.gateway,this.nonce_selector="#"+this.gateway+"_payment_nonce",this.token_selector="#"+this.gateway+"_payment_token",this.$form=a(c.container).closest("form"),void 0===this.$form.attr("id")&&this.$form.attr("id","checkout-form"),this.cvc_required="1"===this.vars.cvc_required,this.has_saved_methods="1"===this.vars.has_saved_methods,a("form.checkout").on("checkout_place_order_"+this.gateway,this.process_order),a(document.body).on("updated_checkout",this.updated_checkout),a(document.body).on("click","#place_order",this.place_order),a(document.body).on("checkout_error",this.checkout_error),a(document.body).on("keyup",'[data-worldpay="number"]',this.update_card_type),a(document.body).on("worldpay_new_method_selected",this.new_method_selected),a(document.body).on("worldpay_saved_method_selected",this.saved_method_selected),a(document.body).on("worldpay_payment_method_changed",this.update_token_attribute),"undefined"!=typeof Worldpay&&Worldpay.card){var o=Worldpay.card.reuseToken;Worldpay.card.reuseToken=function(e,t,r){if(c.cvc_received)return!0;o&&o.call(Worldpay,e,t,r)};var r=Worldpay.card.createToken;Worldpay.card.createToken=function(e,t){if(c.payment_method_received)return!0;r&&r.call(Worldpay,e,t)}}this.initialize_form(),this.has_saved_methods&&this.initialize_cvv()},new_method_selected:function(){c.initialize_form()},saved_method_selected:function(){c.initialize_cvv()},initialize_form:function(){Worldpay.useOwnForm({clientKey:c.vars.client_key,form:c.$form[0],reusable:"1"===c.vars.reusable||a("#online_worldpay_save_cc_key").is(":checked"),formatCardNumber:!0,templateType:"card",cvc:!1,callback:function(e,t){t.error&&200!=e?c.submit_error(t.error):t.token&&(c.worldpay_form_function=c.$form.attr("onsubmit"),c.$form.attr("onsubmit",""),c.on_payment_nonce_received(t))}},a.extend(a(document.body).triggerHandler("worldpay_own_form_params",{})))},initialize_cvv:function(){c.cvc_required_for_vaulted()&&(Worldpay.setClientKey(c.vars.client_key),Worldpay.useOwnForm({clientKey:c.vars.client_key,form:c.$form[0],reusable:"1"===c.vars.reusable,templateType:"cvc",useReusableToken:!0,callback:function(e,t){t.error&&200!=e?c.submit_error(t.error):(c.worldpay_form_function=document.getElementById(c.$form.attr("id")).onsubmit,c.$form.attr("onsubmit",""),c.on_cvc_received(t))}}))},place_order:function(){c.is_gateway_selected()&&(a('[data-worldpay="name"]').val(a("#billing_first_name").val()+" "+a("#billing_last_name").val()),c.use_saved_card()?c.cvc_required&&c.initialize_cvv():c.initialize_form())},update_token_attribute:function(e,t){a(c.token_selector).attr("data-worldpay","token")},updated_checkout:function(){c.initialize_form(),c.has_saved_methods&&c.initialize_cvv()},process_order:function(){return c.use_saved_card()?!c.cvc_required||c.cvc_received:c.payment_method_received},on_payment_nonce_received:function(e){c.payment_method_received=!0,c.set_nonce(e.token),c.$form.submit()},on_cvc_received:function(e){c.cvc_received=!0,c.$form.submit()},set_nonce:function(e){a(c.nonce_selector).val(e)},is_gateway_selected:function(){return a('input[name="payment_method"]:checked').val()===c.gateway},checkout_error:function(){document.getElementById(c.$form.attr("id")).onsubmit=c.worldpay_form_function,c.payment_method_received=!1,c.cvc_received=!1,c.set_nonce(""),a('[data-worldpay="number"]').trigger("keypress")},submit_error:function(e){a(document.body).triggerHandler("worldpay_error_message_handler",{error:e,container:c.$form,gateway:c.gateway})},use_saved_card:function(){return a(c.payment_type_selector).length&&"token"===a(c.payment_type_selector+":checked").val()},update_card_type:function(e){var t,r=a(this).val();void 0!==(t=Worldpay.card.cardFromNumber(r))?a(".worldpay-card-type").attr("src",c.vars.cards[t.type]):a(".worldpay-card-type").attr("src",c.vars.cards.cc_format)},cvc_required_for_vaulted:function(){return c.cvc_required}};c.init()}});